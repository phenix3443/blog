---
title: "Foundry"
description:
slug: ä½¿ç”¨ foundry ç¼–å†™æ™ºèƒ½åˆçº¦
date: 2023-03-15T10:17:15+08:00
image:
math:
license:
hidden: false
comments: true
draft: false
series: [ä»¥å¤ªåŠå¼€å‘å·¥å…·é“¾]
categories:
  - ethereum
tags:
  - foundry
---

æœ¬æ–‡ä»‹ç»å¦‚ä½•ä½¿ç”¨ Foundry ç¼–å†™æ™ºèƒ½åˆçº¦ã€‚

<!--more-->

## æ¦‚è¿°

[foundry](https://github.com/foundry-rs/foundry) æ˜¯ç”¨ Rust ç¼–å†™çš„ç”¨äºä»¥å¤ªåŠåº”ç”¨ç¨‹åºå¼€å‘çš„å¿«é€Ÿã€å¯ç§»æ¤å’Œæ¨¡å—åŒ–å·¥å…·åŒ…ã€‚åŒ…æ‹¬ï¼š

foundry ç”±ä»¥ä¸‹éƒ¨åˆ†ç»„æˆï¼š

- [Forge](https://github.com/foundry-rs/foundry/blob/master/forge): ä»¥å¤ªåŠæµ‹è¯•æ¡†æ¶ï¼ˆç±»ä¼¼ Truffle, Hardhat å’Œ DappToolsï¼‰ã€‚
- [Cast](https://github.com/foundry-rs/foundry/blob/master/cast): ç”¨äºä¸ EVM æ™ºèƒ½åˆçº¦äº’åŠ¨ï¼Œå‘é€äº¤æ˜“å’Œè·å–é“¾ä¸Šæ•°æ®ï¼Œå¯ç”¨äºåˆçº¦è°ƒè¯•ã€‚
- [Anvil](https://github.com/foundry-rs/foundry/blob/master/anvil): æœ¬åœ°ä»¥å¤ªåŠèŠ‚ç‚¹ï¼Œç±»ä¼¼äº Ganacheã€Hardhat ç½‘ç»œã€‚
- [Chisel](https://github.com/foundry-rs/foundry/blob/master/chisel): å¿«é€Ÿã€å®ç”¨ã€è¯¦ç»†çš„ solidity [REPL](https://www.zhihu.com/question/53865469)ã€‚

### ç‰¹è‰²

æœ‰äº† `hardhat + ethers` ä¸ºä»€ä¹ˆè¦ä½¿ç”¨ foundry? ç‰¹è‰²åœ¨äºï¼š

- [å¿«é€Ÿ](https://github.com/foundry-rs/foundry#how-fast) çµæ´»çš„ç¼–è¯‘ç®¡é“
  - è‡ªåŠ¨æ£€æµ‹å’Œå®‰è£… Solidity ç¼–è¯‘å™¨ç‰ˆæœ¬ï¼ˆåœ¨ ~/.svm ä¸‹ï¼‰ã€‚
  - å¢é‡ç¼–è¯‘å’Œç¼“å­˜ï¼šåªå¯¹æ›´æ”¹çš„æ–‡ä»¶è¿›è¡Œé‡æ–°ç¼–è¯‘
  - å¹¶è¡Œç¼–è¯‘
  - æ”¯æŒéæ ‡å‡†ç›®å½•ç»“æ„ï¼ˆå¦‚ [Hardhat repos](https://twitter.com/gakonst/status/1461289225337421829)ï¼‰
- ç”¨ Solidity ç¼–å†™æµ‹è¯•ï¼ˆä¸ DappTools ç±»ä¼¼ï¼‰ï¼Œå¯æœ‰æ•ˆå‡å°‘ä¸Šä¸‹æ–‡åˆ‡æ¢ã€‚ä¸ `hardhat+ethers` ç»„åˆå·¥å…·ç›¸æ¯”ï¼Œhardhat+ethers åˆçº¦ä½¿ç”¨ solidityï¼Œè€Œéƒ¨ç½²æµ‹è¯•ç­‰ä½¿ç”¨ js æˆ–è€… tsã€‚è€Œå¯¹äº foundry å·¥å…·ï¼Œåˆçº¦ã€éƒ¨ç½²ã€æµ‹è¯•ç­‰éƒ½ä½¿ç”¨ solidityï¼Œä¸éœ€è¦åœ¨å¤šç§ç¼–ç¨‹è¯­è¨€ä¹‹é—´è¿›è¡Œåˆ‡æ¢ã€‚
- é€šè¿‡ç¼©å°è¾“å…¥å’Œæ‰“å°åä¾‹è¿›è¡Œå¿«é€Ÿæ¨¡ç³Šæµ‹è¯•ã€‚
- å¿«é€Ÿè¿œç¨‹ RPC åˆ†å‰æ¨¡å¼ï¼Œåˆ©ç”¨ç±»ä¼¼ tokio çš„ Rust å¼‚æ­¥åŸºç¡€æ¶æ„
- çµæ´»çš„è°ƒè¯•æ—¥å¿—
  - DappTools é£æ ¼ï¼Œä½¿ç”¨ `DsTest` è¾“å‡ºçš„æ—¥å¿—
  - Hardhat é£æ ¼ï¼Œä½¿ç”¨æµè¡Œçš„ `console.sol`` åˆçº¦
- ä¾¿æºï¼ˆ5-10MBï¼‰ä¸”æ˜“äºå®‰è£…ï¼Œæ— éœ€ Nix æˆ–å…¶ä»–è½¯ä»¶åŒ…ç®¡ç†å™¨
- é€šè¿‡ [Foundry GitHub](https://github.com/foundry-rs/foundry-toolchain) æ“ä½œå®ç°å¿«é€Ÿ CIã€‚

## å®‰è£…

```shell
curl -L https://foundry.paradigm.xyz | bash
```

è¿™å°†å®‰è£… `fourndryup`ï¼Œç„¶ååªéœ€æŒ‰ç…§å±å¹•ä¸Šçš„è¯´æ˜è¿›è¡Œæ“ä½œï¼Œæ‰§è¡Œ `fourndryup` å‘½ä»¤å°†å®‰è£… foundry çš„å…¶ä»–ç»„ä»¶ã€‚

## é…ç½®

## forge

### test

ä¸€ä¸ªå¥½çš„åšæ³•æ˜¯å°† `test_Revert[If|When]_Condition` ä¸ `expectRevert` cheatcode ç»“åˆä½¿ç”¨ï¼ˆä¸‹ä¸€èŠ‚å°†æ›´è¯¦ç»†åœ°è§£é‡Šä½œå¼Šä»£ç ï¼‰ã€‚

### ä¸å˜é‡æµ‹è¯• (invariant test)

ä¸å˜å¼æµ‹è¯•å…è®¸å¯¹ä¸€ç»„ä¸å˜å¼è¡¨è¾¾å¼è¿›è¡Œæµ‹è¯•ï¼Œæµ‹è¯•çš„å¯¹è±¡æ˜¯æ¥è‡ªé¢„å®šä¹‰åˆçº¦çš„é¢„å®šä¹‰å‡½æ•°è°ƒç”¨éšæœºåºåˆ—ã€‚åœ¨æ‰§è¡Œæ¯æ¬¡å‡½æ•°è°ƒç”¨åï¼Œéƒ½ä¼šå¯¹æ‰€æœ‰å·²å®šä¹‰çš„ä¸å˜å¼è¿›è¡Œæ–­è¨€ã€‚

ä¸å˜å¼æµ‹è¯•æ˜¯æš´éœ²åè®®ä¸­ä¸æ­£ç¡®é€»è¾‘çš„æœ‰åŠ›å·¥å…·ã€‚ç”±äºå‡½æ•°è°ƒç”¨åºåˆ—æ˜¯éšæœºçš„ï¼Œå¹¶ä¸”æœ‰æ¨¡ç³Šè¾“å…¥ï¼Œå› æ­¤ä¸å˜å¼æµ‹è¯•å¯ä»¥æ­ç¤ºè¾¹ç¼˜æƒ…å†µå’Œé«˜åº¦å¤æ‚åè®®çŠ¶æ€ä¸­çš„é”™è¯¯å‡è®¾å’Œä¸æ­£ç¡®é€»è¾‘ã€‚

ä¸å˜å¼æµ‹è¯•æ´»åŠ¨æœ‰ä¸¤ä¸ªç»´åº¦ï¼šè¿è¡Œå’Œæ·±åº¦ï¼š

è¿è¡Œï¼šå‡½æ•°è°ƒç”¨åºåˆ—ç”Ÿæˆå’Œè¿è¡Œçš„æ¬¡æ•°ã€‚
æ·±åº¦ï¼šç‰¹å®šè¿è¡Œä¸­å‡½æ•°è°ƒç”¨çš„æ¬¡æ•°ã€‚æ¯æ¬¡å‡½æ•°è°ƒç”¨åï¼Œéƒ½ä¼šæ–­è¨€æ‰€æœ‰å·²å®šä¹‰çš„ä¸å˜å¼ã€‚å¦‚æœå‡½æ•°è°ƒç”¨å›é€€ï¼Œæ·±åº¦è®¡æ•°å™¨ä»ä¼šé€’å¢ã€‚
æ­¤å¤„å°†å¯¹è¿™äº›å˜é‡å’Œå…¶ä»–ä¸å˜å¼é…ç½®æ–¹é¢è¿›è¡Œè¯´æ˜ã€‚

ä¸åœ¨ Foundry ä¸­è¿è¡Œæ ‡å‡†æµ‹è¯•æ—¶åœ¨å‡½æ•°åå‰ç¼€ä¸Š test ç›¸ä¼¼ï¼Œä¸å˜å¼æµ‹è¯•ä¹Ÿæ˜¯åœ¨å‡½æ•°åå‰ç¼€ä¸Š invariantï¼ˆä¾‹å¦‚ï¼Œå‡½æ•° invariant_A()ï¼‰ã€‚

é…ç½®ä¸å˜å¼æµ‹è¯•çš„æ‰§è¡Œ
ç”¨æˆ·å¯é€šè¿‡ Forge é…ç½®åŸè¯­æ§åˆ¶ä¸å˜å¼æµ‹è¯•çš„æ‰§è¡Œå‚æ•°ã€‚é…ç½®å¯ä»¥å…¨å±€åº”ç”¨ï¼Œä¹Ÿå¯ä»¥æŒ‰æµ‹è¯•åº”ç”¨ã€‚æœ‰å…³æ­¤ä¸»é¢˜çš„è¯¦ç»†ä¿¡æ¯ï¼Œè¯·å‚é˜… ğŸ“š å…¨å±€é…ç½® å’Œ ğŸ“š åœ¨çº¿é…ç½®ã€‚

### å·®å¼‚æµ‹è¯• (Differential Testing)

Forge å¯ç”¨äº differential testing å’Œ differential fuzzingã€‚ç”šè‡³å¯ä»¥ä½¿ç”¨ [ffi cheatcode](https://book.getfoundry.sh/cheatcodes/ffi.html) å¯¹é EVM å¯æ‰§è¡Œæ–‡ä»¶è¿›è¡Œæµ‹è¯•ã€‚

#### èƒŒæ™¯

[differential testing](https://en.wikipedia.org/wiki/Differential_testing) é€šè¿‡æ¯”è¾ƒæ¯ä¸ªå‡½æ•°çš„è¾“å‡ºï¼Œäº¤å‰å¼•ç”¨åŒä¸€å‡½æ•°çš„å¤šä¸ªå®ç°ã€‚å‡è®¾æˆ‘ä»¬æœ‰ä¸€ä¸ªå‡½æ•°è§„èŒƒ F(X)ï¼Œä»¥åŠè¯¥è§„èŒƒçš„ä¸¤ä¸ªå®ç°ï¼šf1(X) å’Œ f2(X)ã€‚æˆ‘ä»¬å¸Œæœ› `f1(x) == f2(x)` é€‚ç”¨äºè¾“å…¥ç©ºé—´ä¸­çš„æ‰€æœ‰ xã€‚å¦‚æœ `f1(x) != f2(x)`ï¼Œæˆ‘ä»¬å°±çŸ¥é“è‡³å°‘æœ‰ä¸€ä¸ªå‡½æ•°é”™è¯¯åœ°å®ç°äº† F(X)ã€‚è¿™ä¸ªæµ‹è¯•ç›¸ç­‰æ€§å’Œè¯†åˆ«å·®å¼‚çš„è¿‡ç¨‹æ˜¯ differential testing çš„æ ¸å¿ƒã€‚

differential fuzzing æ˜¯ differential testing çš„æ‰©å±•ã€‚differential fuzzing ä»¥ç¼–ç¨‹æ–¹å¼ç”Ÿæˆè®¸å¤š x å€¼ï¼Œä»¥å‘ç°äººå·¥é€‰æ‹©çš„è¾“å…¥å¯èƒ½æ— æ³•æ­ç¤ºçš„å·®å¼‚å’Œè¾¹ç¼˜æƒ…å†µã€‚

> æ³¨æ„ï¼šè¿™é‡Œçš„ `==` è¿ç®—ç¬¦å¯ä»¥æ˜¯è‡ªå®šä¹‰çš„ç›¸ç­‰å®šä¹‰ã€‚ä¾‹å¦‚ï¼Œå¦‚æœæµ‹è¯•æµ®ç‚¹å®ç°ï¼Œå¯ä»¥ä½¿ç”¨å…·æœ‰ä¸€å®šå®¹å·®çš„è¿‘ä¼¼ç›¸ç­‰ã€‚

è¿™ç±»æµ‹è¯•åœ¨ç°å®ç”Ÿæ´»ä¸­çš„ä¸€äº›åº”ç”¨åŒ…æ‹¬ï¼š

- æ¯”ä»·å‡çº§å‰åçš„å®ç°
- æ ¹æ®å·²çŸ¥å‚è€ƒå®ç°æµ‹è¯•ä»£ç 
- ç¡®è®¤ä¸ç¬¬ä¸‰æ–¹å·¥å…·å’Œä¾èµ–å…³ç³»çš„å…¼å®¹æ€§

ä»¥ä¸‹æ˜¯ Forge ç”¨äºå·®å¼‚æµ‹è¯•çš„ä¸€äº›ç¤ºä¾‹ã€‚

å…¥é—¨ï¼š ffi ä½œå¼Šç 

[ffi](https://book.getfoundry.sh/cheatcodes/ffi.html) å…è®¸æ‚¨æ‰§è¡Œä»»æ„ shell å‘½ä»¤å¹¶æ•è·è¾“å‡ºã€‚è¿™æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿç¤ºä¾‹ï¼š

## Cast

## Anvil

## Chisel

## æ€»ç»“

## å‚è€ƒ
